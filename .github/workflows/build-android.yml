name: Build Android APK - A Life Is A Random Journey

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # Aumentar a 90 minutos (buildozer puede ser lento)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'  # Cachear pip dependencies
    
    - name: Setup Java 8
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'
    
    - name: Cache buildozer dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.buildozer
          ~/.gradle
        key: ${{ runner.os }}-buildozer-${{ hashFiles('game/buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip python3-pip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libncurses-dev cmake \
          libffi-dev libssl-dev libltdl-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython
    
    - name: Verify installation and environment
      run: |
        buildozer --version
        python --version
        java -version
        echo "JAVA_HOME: $JAVA_HOME"
        echo "PATH: $PATH"
        
    - name: Setup buildozer and verify spec
      run: |
        cd game
        buildozer init || echo "Buildozer already initialized"
        cat buildozer.spec | head -20
        ls -la
        
    - name: Build APK with detailed logging
      run: |
        cd game
        echo "🚀 Iniciando compilación APK..."
        buildozer android debug --verbose 2>&1 | tee build.log
    
    - name: Debug build artifacts
      if: always()
      run: |
        cd game
        echo "📁 Estructura de directorios:"
        find . -name "*.apk" -type f -exec ls -la {} \;
        echo "📋 Contenido de bin/:"
        ls -la bin/ || echo "❌ No bin directory found"
        echo "📋 Contenido de .buildozer/:"
        ls -la .buildozer/ || echo "❌ No .buildozer directory found"
        echo "📝 Últimas líneas del log:"
        tail -50 build.log || echo "❌ No build.log found"
    
    - name: Upload APK Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: alifeisarandomjourney-${{ github.ref_name }}-debug
        path: game/bin/*.apk
        retention-days: 30
    
    - name: Upload build logs (if failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.ref_name }}
        path: |
          game/build.log
          game/.buildozer/android/platform/build-**/logs/**
        retention-days: 7
    
    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/') && success()
      uses: softprops/action-gh-release@v2
      with:
        files: game/bin/*.apk
        draft: false
        prerelease: true
        generate_release_notes: true
        name: "A Life Is A Random Journey ${{ github.ref_name }}"
        body: |
          🎮 **A Life Is A Random Journey ${{ github.ref_name }}**
          
          🚀 **APK Debug Build**
          - 📱 Optimizado para móvil (360x640)
          - 🎨 Interfaz estilo Undertale/Deltarune
          - 🎵 Música CC0 incluida
          - 🎯 Versión de desarrollo
          
          📋 **Instalación:**
          1. Descargar el APK
          2. Habilitar "Fuentes desconocidas" en Android
          3. Instalar y disfrutar!
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 